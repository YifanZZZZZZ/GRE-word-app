<!DOCTYPE html>
<html>
<head>
    <title>Word Quiz</title>
</head>
<body>
    <!-- Mode Selection UI -->
    <div id="modeSelection">
        <h2>Select Mode</h2>
        <label>
            Mode:
            <select id="modeSelect">
                <option value="all">All Words</option>
                <option value="review">Review Wrong Words</option>
            </select>
        </label>

        <label id="logSelectLabel" style="display:none;">
            Log:
            <select id="logSelect"></select>
        </label>

        <button onclick="startQuiz()">Start Quiz</button>
    </div>

    <!-- Quiz UI -->
    <h1 id="word" style="display:none;">Loading...</h1>
    <p id="progress" style="display:none;">Progress: 0 / 0</p>

    <form id="quizForm" style="display:none;">
        <div id="meaningSection">
            <h3>Select all correct meanings</h3>
            <div id="meaningOptions"></div>
        </div>
        <br/>
        <div id="synonymSection">
            <h3>Select all synonyms</h3>
            <div id="synonymOptions"></div>
        </div>
        <br/>
        <button type="submit">Submit</button>
    </form>

    <p id="feedback"></p>
    <button id="retryButton" style="display:none;" onclick="retryWrongWords()">üîÅ Retry Wrong Words</button>
    <button id="nextButton" style="display:none;" onclick="nextQuestion()">‚û°Ô∏è Next</button>

    <script>
        let currentWord = "";
        let correctMeanings = [];
        let correctSynonyms = [];
        let retryMode = false;

        document.getElementById("modeSelect").addEventListener("change", async () => {
            const mode = document.getElementById("modeSelect").value;
            const logLabel = document.getElementById("logSelectLabel");

            if (mode === "review") {
                logLabel.style.display = "inline";
                const res = await fetch("/api/logs");
                const logs = await res.json();
                document.getElementById("logSelect").innerHTML = logs.logs
                    .map(log => `<option value="${log}">${log}</option>`)
                    .join("");
            } else {
                logLabel.style.display = "none";
            }
        });

        async function startQuiz() {
            const mode = document.getElementById("modeSelect").value;
            const log = document.getElementById("logSelect").value;

            await fetch("/api/set_mode", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ mode, log })
            });

            document.getElementById("modeSelection").style.display = "none";
            document.getElementById("word").style.display = "block";
            document.getElementById("progress").style.display = "block";
            document.getElementById("quizForm").style.display = "block";

            loadQuestion();
        }

        async function loadQuestion() {
            const res = await fetch("/api/question");
            const data = await res.json();

            if (data.done) {
                document.getElementById("word").innerText = "‚úÖ All words tested!";
                document.getElementById("meaningOptions").innerHTML = "";
                document.getElementById("synonymOptions").innerHTML = "";
                document.getElementById("progress").innerText = "";
                document.getElementById("feedback").innerText = "";

                const wrongRes = await fetch("/api/wrong");
                const wrongData = await wrongRes.json();

                let feedback = "<h3>Words you got wrong:</h3>";
                if (wrongData.wrong.length === 0) {
                    feedback += "<p>üéâ You got everything correct!</p>";
                } else {
                    feedback += "<ul>" + wrongData.wrong.map(w => `<li>${w}</li>`).join("") + "</ul>";
                    if (!data.retry_mode) {
                        document.getElementById("retryButton").style.display = "inline";
                    }
                }

                document.getElementById("meaningOptions").innerHTML = feedback;
                return;
            }

            document.getElementById("retryButton").style.display = "none";
            document.getElementById("nextButton").style.display = "none";
            document.getElementById("feedback").innerText = "";

            currentWord = data.word;
            correctMeanings = data.meanings;
            correctSynonyms = data.synonyms;
            retryMode = data.retry_mode;

            document.getElementById("word").innerText = `What does \"${currentWord}\" mean?`;
            document.getElementById("progress").innerText = `Progress: ${data.progress} / ${data.total}`;

            const meaningDiv = document.getElementById("meaningOptions");
            meaningDiv.innerHTML = "";
            data.meaning_options.forEach(m => {
                meaningDiv.innerHTML += `
                    <label><input type="checkbox" name="meaning" value="${m}"> ${m}</label><br/>
                `;
            });

            const synonymDiv = document.getElementById("synonymOptions");
            synonymDiv.innerHTML = "";
            data.synonym_options.forEach(s => {
                synonymDiv.innerHTML += `
                    <label><input type="checkbox" name="synonym" value="${s}"> ${s}</label><br/>
                `;
            });
        }

        document.getElementById("quizForm").addEventListener("submit", async function(e) {
            e.preventDefault();
            const selectedMeanings = [...document.querySelectorAll("input[name='meaning']:checked")].map(i => i.value);
            const selectedSynonyms = [...document.querySelectorAll("input[name='synonym']:checked")].map(i => i.value);

            const res = await fetch("/api/submit", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    word: currentWord,
                    selected_meanings: selectedMeanings,
                    selected_synonyms: selectedSynonyms
                })
            });

            const result = await res.json();

            if (result.result) {
                document.getElementById("feedback").innerText = "‚úÖ You're right!";
                setTimeout(() => {
                    document.getElementById("feedback").innerText = "";
                    loadQuestion();
                }, 1000);
            } else {
                document.getElementById("feedback").innerHTML = `
                    ‚ùå Try Again!<br/>
                    ‚úÖ Correct meanings: ${result.correct_meanings.join(", ")}<br/>
                    ‚úÖ Correct synonyms: ${result.correct_synonyms.join(", ")}
                `;

                document.querySelectorAll("input[name='meaning']").forEach(i => i.disabled = true);
                document.querySelectorAll("input[name='synonym']").forEach(i => i.disabled = true);
                document.querySelector("button[type='submit']").disabled = true;
                document.getElementById("nextButton").style.display = "inline";
            }
        });

        function nextQuestion() {
            document.getElementById("feedback").innerText = "";
            document.getElementById("nextButton").style.display = "none";
            document.querySelector("button[type='submit']").disabled = false;
            document.querySelectorAll("input[name='meaning']").forEach(i => i.disabled = false);
            document.querySelectorAll("input[name='synonym']").forEach(i => i.disabled = false);
            loadQuestion();
        }

        async function retryWrongWords() {
            await fetch("/api/retry_wrong", { method: "POST" });
            document.getElementById("retryButton").style.display = "none";
            document.getElementById("feedback").innerText = "";
            loadQuestion();
        }
    </script>
</body>
</html>
